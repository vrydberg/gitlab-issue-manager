<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head'); %>
</head>
<body class="has-timeline">

    <%- include('../partials/auth-header') -%>

    <main id="main-expanded">

        <div class="expanded-header">
            <a href="/issues/<%= typeof mock !== 'undefined' ? '?mock=true' : '' %>" class="back-link">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                    <path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Issues
            </a>
            <span class="header-separator">/</span>
            <h2>Issue #<%= issue ? issue.iid : '' %></h2>
        </div>

        <% if (issue) { %>
            <div class="expanded-issue">

                <div class="expanded-issue-top">
                    <div class="expanded-issue-header">
                        <h2 class="issue-title"><%= issue.title %></h2>
                        <div class="expanded-btns-container">

                            <% if (issue.state === 'opened') { %>
                                <form class="update-status-form" action="/issues/update-issue-status/<%= issue.iid %>" method="POST">
                                    <input type="hidden" name="state_event" value="close">
                                    <button type="submit" class="update-status-btn close-issue-btn">Close issue</button>
                                </form>
                            <% } else { %>
                                <form class="update-status-form" action="/issues/update-issue-status/<%= issue.iid %>" method="POST">
                                    <input type="hidden" name="state_event" value="reopen">
                                    <button type="submit" class="update-status-btn reopen-issue-btn">Reopen issue</button>
                                </form>
                            <% } %>

                            <a href="/issues/edit/<%= issue.iid %><%= typeof mock !== 'undefined' ? '?mock=true' : '' %>" class="expanded-btn" title="Edit issue">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                                    <path d="M11.5 2.5l2 2-8 8H3.5v-2l8-8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 4l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </a>

                        </div>
                    </div>

                    <% if (issue.description) { %>
                        <p><%= issue.description %></p>
                    <% } %>

                    <div class="issue-info">
                        <% if (issue.state === 'opened') { %>
                            <span class="issue-status status-open">
                                <span class="status-dot"></span>
                                Open
                            </span>
                        <% } else { %>
                            <span class="issue-status status-closed">
                                <span class="status-dot"></span>
                                Closed
                            </span>
                        <% } %>

                        <p class="issue-info">Opened <span class="issue-date"><%= issue.created_at %></span> by <span class="issue-user"><%= issue.author.username %></span></p>
                    </div>
                </div>

                <div class="expanded-issue-bottom">
                    <h3 class="issue-title">Comments</h3>


                    <div class="comments-container">
                        <% if (comments.length > 0) { %>

                            <% for (let i = 0; i < comments.length; i++) { %>

                                <div class="comment">
                                    <p class="comment-user"><%= comments[i].author.username %> <span class="comment-time">&middot; <%= comments[i].created_at %></span></p>
                                    <p class="comment-text"><%= comments[i].body %></p>
                                </div>
                            <% } %>

                        <% } %>
                    </div>

                    <form action="/issues/add-comment/<%= issue.iid %>" method="POST" class="comment-form">
                        <div class="comment-form-input-container">
                            <textarea class="comment-form-textarea" id="new-comment" name="comment" rows="4" placeholder="Add a comment..." required></textarea>

                            <div class="comment-form-btn-container">
                                <button type="submit" class="comment-btn">Post Comment</button>
                            </div>
                        </div>
                    </form>

                </div>

            </div>
        <% } else { %>
            <div class="error-state">
                <p>Unable to load issue. The requested issue may not exist or you may not have permission to view it.</p>
                <a href="/issues/" class="back-btn">Return to Issues</a>
            </div>
        <% } %>


    </main>


    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/client.js"></script>
</body>
</html>
